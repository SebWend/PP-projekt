#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef enum { AKTYWNY, NA_MISJI, RANNY, ZAGINIONY, ZAWIESZONY } Status;

const char *status_na_string(Status s) {
    switch (s) {
        case AKTYWNY:   return "Aktywny";
        case NA_MISJI:  return "Na misji";
        case RANNY:     return "Ranny";
        case ZAGINIONY: return "Zaginiony";
        case ZAWIESZONY: return "Zawieszony";
        default:        return "Nieznany";
    }
}

typedef struct Hero {
    char imie[101];
    char rasa[50];
    int poziom;
    int reputacja;
    Status status;
    struct Hero *next;
} Hero;

void wyswietlanie(Hero *head) {
    if (head == NULL) {
        printf("\nRejestr jest pusty\n");
        return;
    }

    printf("\n%-20s | %-12s | %-6s | %-10s | %-12s\n",
           "IMIE", "RASA", "POZIOM", "REPUTACJA", "STATUS");
    printf("---------------------------------------------------------------------------\n");

    while (head != NULL) {
        printf("%-20s | %-12s | %-6d | %-10d | %-12s\n",
               head->imie,
               head->rasa,
               head->poziom,
               head->reputacja,
               status_na_string(head->status));

        head = head->next;
    }
    printf("---------------------------------------------------------------------------\n");
}

Hero *rejestracja(Hero *head) {
    char imie_p[101];

    printf("Podaj imie bohatera: ");
    scanf("%100s", imie_p);

    Hero *current = head;
    while (current != NULL) {
        if (strcmp(current->imie, imie_p) == 0) {
            printf("Blad: Bohater o imieniu '%100s' juz istnieje w rejestrze!\n", imie_p);
            return head;
        }
        current = current->next;
    }

    Hero *nowy = malloc(sizeof(Hero));
    if (nowy == NULL) {
        printf("Blad: Nie udalo sie przydzielic pamieci!\n");
        return head;
    }

    strcpy(nowy->imie, imie_p);
    printf("Podaj rase: ");
    scanf("%49s", nowy->rasa);

    while(1) {
        printf("Podaj poziom: ");
        if (scanf("%d", &nowy->poziom) != 1) {
            printf("Blad: Nieprawidlowy format liczby!\n");
            while(getchar() != '\n');
            continue;
        }
        else {
        break;
        }
    }

    while(1) {
        printf("Podaj reputacje (0-100): ");
        if (scanf("%d", &nowy->reputacja) != 1) {
            printf("Blad: Nieprawidlowy format liczby!\n");
            while(getchar() != '\n');
            continue;
        }
        if (nowy->reputacja < 0 || nowy->reputacja > 100) {
            printf("Blad: Reputacja musi miescic sie w zakresie od 0 do 100!\n");
        }
        else
            break;
    }
    nowy->status = AKTYWNY;
    nowy->next = head;

    printf("Bohater %s zostal pomyslnie dodany do rejestru.\n", nowy->imie);
    return nowy;
}

Hero *usun_imie(Hero *head, char *imie_do_usuniecia) {
    if (head == NULL) {
        printf("Rejestr jest pusty, nie ma kogo usunac.\n");
        return NULL;
    }

    Hero *current = head;
    Hero *prev = NULL;

    while (current != NULL && strcmp(current->imie, imie_do_usuniecia) != 0) {
        prev = current;
        current = current->next;
    }

    if (current == NULL) {
        printf("Bohater o imieniu '%s' nie jest w rejestrze.\n", imie_do_usuniecia);
        return head;
    }

    if (current->status == NA_MISJI) {
        printf("Blad: Nie mozna usunac bohatera %s, poniewaz przebywa na misji!\n", current->imie);
        return head;
    }

    if (prev == NULL) {
        head = current->next;
    }
    else {
        prev->next = current->next;
    }

    free(current);
    printf("Bohater %s zostal pomyslnie usuniety z rejestru.\n", imie_do_usuniecia);
    return head;
}

Hero *usun_rep(Hero *head, int lim_rep) {
    Hero *current = head;
    Hero *prev = NULL;
    int licznik = 0;

    while (current != NULL) {
        if (current->reputacja <= lim_rep) {

            if (current->status == NA_MISJI) {
                printf("Blad: Nie mozna usunac bohatera %s, poniewaz przebywa na misji!\n", current->imie);
                prev = current;
                current = current->next;
            }
            else {
                Hero *do_usuniecia = current;

                printf("Usuwanie: %s (Reputacja: %d)\n", current->imie, current->reputacja);

                if (prev == NULL) {
                    head = current->next;
                    current = head;
                }
                else {
                    prev->next = current->next;
                    current = current->next;
                }
                free(do_usuniecia);
                licznik++;
            }
        }
        else {
            prev = current;
            current = current->next;
        }
    }

    printf("Usunieto %d bohaterow.\n", licznik);

    return head;
}

void wyszukiwanie(Hero *head) {
    int tryb;
    int licznik = 0;
    Hero *current = head;
    printf("\nSzukaj wedlug:\n1. Imienia\n2. Minimalnego poziomu\nWybor: ");
    while(1) {
        if (scanf("%d", &tryb) != 1) {
            printf("Blad: Podaj liczbe!\n");
            while(getchar() != '\n');
        }
        else {
            break;
        }
    }

    if (tryb == 1) {
        char szukane[101];
        printf("Podaj imie: ");
        scanf("%100s", szukane);
        int len = strlen(szukane);
        while(current != NULL) {
            if (strncmp(current->imie, szukane, len) == 0) {
                printf("Znaleziono: %s, Poziom: %d, Status: %s\n", current->imie, current->poziom, status_na_string(current->status));
                licznik++;
            }
            current = current->next;
        }
    } else {
        int min_p;
        printf("Podaj min. poziom: ");
        while(1) {
            if (scanf("%d", &min_p) != 1) {
                printf("Blad: Podaj liczbe!\n");
                while(getchar() != '\n');
            }
            else {
                break;
            }
        }

        while(current != NULL) {
            if (current->poziom >= min_p) {
                printf("%s (lvl %d)\n", current->imie, current->poziom);
                licznik++;
            }
            current = current->next;
        }
    }
    if(licznik == 0)
        printf("Nie znaleziono takiej osoby\n");
}

void modyfikowanie(Hero *head) {
    char imie[101];
    printf("Podaj imie bohatera do edycji: ");
    scanf("%100s", imie);
    Hero *current = head;
    int licznik = 0;
    while(current != NULL) {
        if (strcmp(current->imie, imie) == 0) {
            printf("Edycja bohatera: %s (Imie niezmienialne)\n", current->imie);
            licznik++;
            printf("Nowy poziom: ");
            scanf("%d", &current->poziom);
            printf("Nowy status (0-Aktywny, 1-Misja, 2-Ranny, 3-Zaginiony, 4-Zawieszony): ");
            int s;
            scanf("%d", &s);
            current->status = (Status)s;
            printf("Dane zaktualizowane.\n");
            return;
        }
        current = current->next;
    }
    if(licznik == 0)
        printf("Nie znaleziono bohatera.\n");
}

void sortowanie(Hero *head) {
    if (head == NULL) {
        printf("Rejestr jest pusty - nie ma czego sortowac.\n");
        return;
    }

    int wybor;
    printf("\nWybor sortowania:\n1. Alfabetycznie (Imie)\n2. Liczbowo (Poziom)\nWybor: ");
    scanf("%d", &wybor);

    int zamiana;
    Hero *current = head;
    Hero *prev = NULL;

    do {
        zamiana = 0;
        current = head;
        while (current->next != prev) {
            int warunek = 0;
            if (wybor == 1) {
                if (strcmp(current->imie, current->next->imie) > 0) warunek = 1;
            } else {
                if (current->poziom > current->next->poziom) warunek = 1;
            }

            if (warunek == 1) {
                Hero *temp;
                // Kopiowanie danych do temp
                strcpy(temp->imie, current->imie);
                strcpy(temp->rasa, current->rasa);
                temp->poziom = current->poziom;
                temp->reputacja = current->reputacja;
                temp->status = current->status;

                // Przenoszenie danych z nastepnego wezla
                strcpy(current->imie, current->next->imie);
                strcpy(current->rasa, current->next->rasa);
                current->poziom = current->next->poziom;
                current->reputacja = current->next->reputacja;
                current->status = current->next->status;

                // Przywracanie z struktury pomocniczej
                strcpy(current->next->imie, temp->imie);
                strcpy(current->next->rasa, temp->rasa);
                current->next->poziom = temp->poziom;
                current->next->reputacja = temp->reputacja;
                current->next->status = temp->status;

                zamiana = 1;
            }
            current = current->next;
        }
        prev = current;
    } while (zamiana);

    printf("\nRejestr posortowany:\n");
    wyswietlanie(head);
}

Hero *wczytaj_z_pliku(Hero *head, const char *nazwa_pliku) {
    FILE *plik = fopen(nazwa_pliku, "r");

    if (plik == NULL) {
        printf("Plik '%s' nie istnieje lub nie mozna go otworzyc. Rozpoczynanie z pustym rejestrem.\n", nazwa_pliku);
        return head;
    }

    char t_imie[101], t_rasa[50];
    int t_poziom, t_reputacja, t_status;
    int licznik = 0;

    while (fscanf(plik, "%100s %49s %d %d %d", t_imie, t_rasa, &t_poziom, &t_reputacja, &t_status) == 5) {

        Hero *nowy = malloc(sizeof(Hero));
        if (nowy == NULL) {
            printf("Blad: Alokacja pamieci!\n");
            break;
        }

        strcpy(nowy->imie, t_imie);
        strcpy(nowy->rasa, t_rasa);
        nowy->poziom = t_poziom;
        nowy->reputacja = t_reputacja;
        nowy->status = (Status)t_status;

        nowy->next = head;
        head = nowy;

        licznik++;
    }

    fclose(plik);

    if (licznik > 0) {
        printf("Wczytano %d bohaterow.\n", licznik);
    }

    return head;
}

void zapisz_do_pliku(Hero *head, const char *nazwa_pliku) {
    FILE *plik = fopen(nazwa_pliku, "w");
    if (plik == NULL) {
        printf("Blad: Nie udalo sie otworzyc pliku '%s' do zapisu!\n", nazwa_pliku);
        return;
    }

    Hero *current = head;
    int licznik = 0;
    while (current != NULL) {
        fprintf(plik, "%s %s %d %d %d\n",
                current->imie,
                current->rasa,
                current->poziom,
                current->reputacja,
                current->status);
        current = current->next;
        licznik++;
    }

    fclose(plik);
    printf("Pomyslnie zapisano %d bohaterow do pliku: %s\n", licznik, nazwa_pliku);
}

void zwolnij_liste(Hero* head) {
    Hero *current = head;
    Hero *nastepny;

    while (current != NULL) {
        nastepny = current->next;
        printf("Zwalnianie pamieci dla bohatera: %s\n", current->imie);
        free(current);
        current = nastepny;
    }
    printf("Pamiec zostala wyczyszczona.\n");
}

int main(int liczba_arg, char *v_arg[]) {
    char nazwa_pliku_wej[100];
    char nazwa_pliku_wyj[100];
    Hero *head = NULL;
    int wybor, wybor2;

 //   if (liczba_arg < 3) {
 //       printf("Nie podano plikÃ³w.\n");
 //       printf("Podaj nazwe pliku do odczytu (np. baza.txt): ");
 //       scanf("%99s", nazwa_pliku_wej);
 //       printf("Podaj nazwe pliku do zapisu (np. wynik.txt): ");
 //      scanf("%99s", nazwa_pliku_wyj);
 //   } else {
        strcpy(nazwa_pliku_wej, v_arg[1]);
        strcpy(nazwa_pliku_wyj, v_arg[2]);
 //   }

    head = wczytaj_z_pliku(head, nazwa_pliku_wej);

    printf("--- Rejestr Bohaterow Gildii Poszukiwaczy Przygod ---\n");

    while (1) {
        printf("\nMENU GILDII:\n");
        printf("1. Wyswietl wszystkich bohaterow\n");
        printf("2. Dodaj nowego bohatera\n");
        printf("3. Usun bohatera\n");
        printf("4. Wyszukaj bohatera\n");
        printf("5. Modyfikuj bohatera\n");
        printf("6. Posortuj bohaterow\n");
        printf("7. Zapisz do pliku\n");
        printf("8. Wyjdz z rejestru gildii\n");
        printf("Wybor: ");

        if (scanf("%d", &wybor) != 1) {
            printf("Blad: Podaj liczbe!\n");
            while(getchar() != '\n');
            continue;
        }

        switch (wybor) {
            case 1:
                wyswietlanie(head);
                break;
            case 2:
                head = rejestracja(head);
                break;
            case 3:
                printf("Wybierz:\n1. Usuniecie pojedyncze.\n2. Usuniecie wedlug reputacji\n");
                scanf("%d", &wybor2);
                if(wybor2 == 1) {
                    char imie_do_usuniecia[101];
                    printf("Podaj imie bohatera do usuniecia: \n");
                    scanf("%100s", imie_do_usuniecia);
                    head = usun_imie(head, imie_do_usuniecia);
                }
                else {
                    if(wybor2 == 2) {
                        int lim_rep;
                        printf("Podaj maksymalna reputacje (bohaterowie z ta lub mniejsza zostana usunieci\n): ");
                        if (scanf("%d", &lim_rep) == 1) {
                            head = usun_rep(head, lim_rep);
                        } else {
                            printf("Blad: To nie jest liczba.\n");
                            while(getchar() != '\n');
                        }
                    }
                }
                break;
            case 4:
                wyszukiwanie(head);
                break;
            case 5:
                modyfikowanie(head);
                break;
            case 6:
                sortowanie(head);
                break;
            case 7:
                zapisz_do_pliku(head, nazwa_pliku_wyj);
                break;
            case 8:
                zwolnij_liste(head);
                printf("Wyjscie z rejestru gildii\n");
                return 0;
            default:
                printf("Niepoprawny wybor. Sprobuj ponownie.\n");
        }
    }
    return 0;
}
